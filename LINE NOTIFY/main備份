import requests
import os
import json
from dotenv import load_dotenv
import schedule
import time
import logging
from datetime import datetime, timedelta
from logging.handlers import RotatingFileHandler

# ç²å–ç¨‹å¼ç¢¼æ‰€åœ¨ç›®éŒ„
current_directory = os.path.dirname(os.path.abspath(__file__))

# æ—¥èªŒæ–‡ä»¶è·¯å¾‘
weather_log_file_path = os.path.join(current_directory, 'weather.log')
water_log_file_path = os.path.join(current_directory, 'water.log')
menstrual_log_file_path = os.path.join(current_directory, 'Menstrual_reminder.log')

# è¨­ç½®å¤©æ°£æ—¥èªŒ
weather_logger = logging.getLogger('weather_logger')
weather_logger.setLevel(logging.DEBUG)

weather_file_handler = RotatingFileHandler(weather_log_file_path, maxBytes=5e6, backupCount=1)  # 5MB
weather_file_handler.setLevel(logging.INFO)

weather_formatter = logging.Formatter('%(asctime)s - %(levelname)s - %(message)s')
weather_file_handler.setFormatter(weather_formatter)

weather_logger.addHandler(weather_file_handler)

# è¨­ç½®å–æ°´æé†’æ—¥èªŒ
water_logger = logging.getLogger('water_logger')
water_logger.setLevel(logging.DEBUG)

water_file_handler = RotatingFileHandler(water_log_file_path, maxBytes=3e6, backupCount=1)  # 3MB
water_file_handler.setLevel(logging.INFO)

water_formatter = logging.Formatter('%(asctime)s - %(levelname)s - %(message)s')
water_file_handler.setFormatter(water_formatter)

water_logger.addHandler(water_file_handler)

# è¨­ç½®æœˆç¶“æé†’æ—¥èªŒ
menstrual_logger = logging.getLogger('menstrual_logger')
menstrual_logger.setLevel(logging.DEBUG)

# æ–‡ä»¶è™•ç†å™¨
menstrual_file_handler = RotatingFileHandler(menstrual_log_file_path, maxBytes=1e6, backupCount=1)  # 1MB
menstrual_file_handler.setLevel(logging.INFO)

menstrual_formatter = logging.Formatter('%(asctime)s - %(levelname)s - %(message)s')
menstrual_file_handler.setFormatter(menstrual_formatter)

menstrual_logger.addHandler(menstrual_file_handler)


# è¼‰å…¥ .env æª”æ¡ˆ
load_dotenv('line notify.env')

# å–å¾— LINE Notify API Token å’Œé…ç½®è·¯å¾‘
Chose_API = input('1: å€‹äºº\n2: ç¾¤çµ„\n:')
if Chose_API == '1':    
    LINE_NOTIFY_TOKEN = os.getenv('LINE_NOTIFY_TOKEN')  # å€‹äººTOKEN
    print('å·²ä½¿ç”¨å€‹äººLine Notifyã€‚')
elif Chose_API == '2':
    LINE_NOTIFY_TOKEN = os.getenv('GROUP_TOKEN')        # ç¾¤çµ„TOKEN
    print('å·²ä½¿ç”¨ç¾¤çµ„Line Notifyã€‚')
else:
    print("ç„¡æ•ˆçš„é¸æ“‡ï¼Œè«‹é‡æ–°é‹è¡Œç¨‹åºä¸¦é¸æ“‡ 1 æˆ– 2ã€‚")
    exit()

LINE_NOTIFY_API_URL = 'https://notify-api.line.me/api/notify'
WEATHER_API_TOKEN = os.getenv('MYSELF_API')
config_path = os.getenv('CONFIG_PATH')
NEW_WEATHER_API_URL = os.getenv('NEW_WEATHER_URL')

# è®€å–é…ç½®æ–‡ä»¶
def load_config():
    if not config_path:
        raise ValueError("CONFIG_PATH æœªè¨­å®š")
    
    if not os.path.isfile(config_path):
        raise FileNotFoundError(f"é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {config_path}")

    with open(config_path, 'r', encoding='utf-8') as f:
        config = json.load(f)
    
    # é©—è­‰å¿…è¦çš„é…ç½®é …
    required_keys = ['menstrual', 'cities', 'weather_times', 'water_times']
    for key in required_keys:
        if key not in config:
            raise ValueError(f"é…ç½®æ–‡ä»¶ç¼ºå°‘å¿…è¦çš„é …ç›®: {key}")
    
    return config

# ç™¼é€æ¶ˆæ¯åˆ° LINE Notify
def send_line_notify(message, logger, retries=3, delay=5):
    headers = {
        'Authorization': f'Bearer {LINE_NOTIFY_TOKEN}',
        'Content-Type': 'application/x-www-form-urlencoded'
    }
    payload = {'message': message}
    for attempt in range(retries):
        try:
            response = requests.post(LINE_NOTIFY_API_URL, headers=headers, data=payload)
            response.raise_for_status()  # æª¢æŸ¥ HTTP éŒ¯èª¤
            logger.info("é€šçŸ¥ç™¼é€æˆåŠŸï¼")
            break
        except requests.exceptions.RequestException as e:
            logger.error(f"é€šçŸ¥ç™¼é€å¤±æ•—ï¼ŒéŒ¯èª¤: {e}")
            if attempt < retries - 1:
                logger.info(f"ç­‰å¾… {delay} ç§’å¾Œé‡è©¦...")
                time.sleep(delay)
    else:
        logger.error(f"é€šçŸ¥ç™¼é€å¤±æ•—ï¼ŒéŒ¯èª¤: {e}")

# æŸ¥è©¢å¤©æ°£ä¸¦ç™¼é€åˆ° LINE Notify
def fetch_weather_and_notify(city_name):
    """æŸ¥è©¢å¤©æ°£ä¸¦ç™¼é€åˆ° LINE Notify"""
    url = f"https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization={WEATHER_API_TOKEN}"
    
    try:
        response = requests.get(url)
        response.raise_for_status()  # æª¢æŸ¥ HTTP éŒ¯èª¤

        data = response.json()

        # è™•ç†æ°£è±¡è³‡æ–™
        location_data = next((item for item in data.get("records", {}).get("location", []) if item["locationName"] == city_name), None)
        
        if location_data:
            weather_element = {elem.get('elementName', 'æœªçŸ¥'): elem for elem in location_data.get("weatherElement", [])}
            
            times = weather_element.get("Wx", {}).get("time", [])
            if times:
                date_range = f"{times[0].get('startTime', 'æœªçŸ¥')[:10]} è‡³ {times[-1].get('endTime', 'æœªçŸ¥')[:10]}"
            else:
                date_range = "æœªçŸ¥"
            
            weather = weather_element.get("Wx", {}).get("time", [{}])[0].get("parameter", {}).get("parameterName", "æœªçŸ¥")
            rain_probability = weather_element.get("PoP", {}).get("time", [{}])[0].get("parameter", {}).get("parameterName", "æœªçŸ¥")
            min_temp = weather_element.get("MinT", {}).get("time", [{}])[0].get("parameter", {}).get("parameterName", "æœªçŸ¥")
            max_temp = weather_element.get("MaxT", {}).get("time", [{}])[0].get("parameter", {}).get("parameterName", "æœªçŸ¥")

            notification_message = ""
            try:
                rain_prob_int = int(rain_probability)
                max_temp_int = int(max_temp)
                if rain_prob_int > 50 and max_temp_int > 30:
                    notification_message = "\nâ˜” æ©Ÿç‡è¶…é50%ï¼ŒğŸ”¥è¶…é30Â°Cï¼Œè¨˜å¾—æ”œå¸¶é›¨å…·ä¸¦æ³¨æ„é˜²æš‘ï¼"
                elif rain_prob_int > 50:
                    notification_message = "\nâ˜” é™é›¨æ©Ÿç‡è¶…é50%ï¼Œè¨˜å¾—æ”œå¸¶é›¨å…·ï¼"
                elif max_temp_int > 30:
                    notification_message = "\nğŸ”¥ é«˜æº«è¶…é30Â°Cï¼Œè«‹æ³¨æ„é˜²æš‘ï¼"
            except ValueError:
                # å¦‚æœè½‰æ›å¤±æ•—ï¼Œå‰‡ä¸é™„åŠ é¡å¤–è¨Šæ¯
                pass

            message = (
                f"ğŸ“£ å¤©æ°£é å ± ğŸš¨\n"
                f"åœ°é»: ã€{city_name}ã€‘\n"
                f"æ—¥æœŸ: {date_range}\n"
                f"ğŸŒ¤ å¤©æ°£ç‹€æ³: {weather}\n"
                f"â˜” é™é›¨æ©Ÿç‡: {rain_probability}%\n"
                f"ğŸŒ¡ æœ€é«˜æº«åº¦: {max_temp}Â°C\n"
                f"ğŸŒ¡ æœ€ä½æº«åº¦: {min_temp}Â°C"
                f"{notification_message}"
            )
            
            send_line_notify(message, weather_logger)
        else:
            weather_logger.warning(f"ç„¡æ³•å–å¾— {city_name} çš„å¤©æ°£è³‡æ–™ã€‚")
    
    except requests.exceptions.RequestException as e:
        weather_logger.error(f"è«‹æ±‚ç™¼ç”ŸéŒ¯èª¤: {e}")
    except ValueError as e:
        weather_logger.error(f"JSON è§£æéŒ¯èª¤: {e}")

# è®€å–é…ç½®
config = load_config()
menstrual_config = config['menstrual']

# è¨­å®šä¸Šä¸€æ¬¡æœˆç¶“çµæŸæ—¥æœŸ
last_period_end_date = datetime.strptime(menstrual_config['last_period_end_date'], '%Y-%m-%d')

# è¨ˆç®—ä¸‹ä¸€æ¬¡æœˆç¶“çš„é è¨ˆæ—¥æœŸå’Œæé†’æ—¥æœŸ
cycle_length = menstrual_config['cycle_length']
reminder_start_day = menstrual_config['reminder_start_day']
reminder_duration = menstrual_config['reminder_duration']

next_period_start_date = last_period_end_date + timedelta(days=cycle_length)
reminder_start_date = last_period_end_date + timedelta(days=reminder_start_day)

# ç™¼é€æœˆç¶“æé†’
def send_menstrual_reminder():
    """ç™¼é€æœˆç¶“æé†’åˆ° LINE Notify"""
    today = datetime.now().date()
    reminder_end_date = reminder_start_date.date() + timedelta(days=reminder_duration)
    
    if reminder_start_date.date() <= today <= reminder_end_date:
        message = "ğŸŒ¸ å˜¿å˜¿ï¼Œå°æé†’ï½\nä½ çš„å°ç´…å³å°‡ä¾†è¨ªå•¦ï¼\nåˆ¥å¿˜äº†æº–å‚™å¥½å…¶ä»–ç‰©å“å–” ğŸ’ªğŸ˜Œ"
        try:
            send_line_notify(message, menstrual_logger)
            menstrual_logger.info(f"æœˆç¶“æé†’ç™¼é€æˆåŠŸï¼æ–¼: {datetime.now()}")
        except Exception as e:
            menstrual_logger.error(f"æœˆç¶“æé†’ç™¼é€å¤±æ•—ï¼ŒéŒ¯èª¤: {e}")
    else:
        menstrual_logger.info(f"ä»Šå¤© {today} ä¸åœ¨æé†’ç¯„åœå…§ ({reminder_start_date.strftime('%Y-%m-%d')} - {reminder_end_date.strftime('%Y-%m-%d')}), ç„¡éœ€ç™¼é€è¨Šæ¯")

# ç™¼é€å–æ°´æé†’åˆ° LINE Notify
def send_drink_water_reminder():
    """ç™¼é€å–æ°´æé†’åˆ° LINE Notify"""
    message = "ğŸš° å–æ°´æ™‚é–“åˆ°ï¼\nè«‹è¨˜å¾—å–ä¸€æ¯æ°´ï¼Œä¿æŒèº«é«”å¥åº·ã€‚"
    send_line_notify(message, water_logger)

# è®€å–é…ç½®æ–‡ä»¶ä¸¦åŸ·è¡Œå¤©æ°£é å ±
def job_weather():
    try:
        config = load_config()
        cities_to_notify = config.get('cities', [])
        for city in cities_to_notify:
            fetch_weather_and_notify(city)
    except (FileNotFoundError, ValueError) as e:
        weather_logger.error(f"é…ç½®æ–‡ä»¶éŒ¯èª¤: {e}")
        exit(1)

# è®€å–å–æ°´æé†’æ™‚é–“
def schedule_drink_water_reminder():
    json_file_path = os.path.join('line notify', 'config.json')
    if not os.path.isfile(json_file_path):
        water_logger.error(f"å–æ°´æé†’é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {json_file_path}")
        return
    try:
        with open(json_file_path, 'r') as file:
            config = json.load(file)
        reminder_times = config.get('water_times', [])
        
        for water_time in reminder_times:
            schedule.every().day.at(water_time).do(send_drink_water_reminder)
            water_logger.info(f"å·²è¨­å®šå–æ°´æé†’æ™‚é–“: {water_time}")
    except json.JSONDecodeError as e:
        water_logger.error(f"å–æ°´æé†’é…ç½®æ–‡ä»¶è§£æéŒ¯èª¤: {e}")

# è¨­ç½®æœˆç¶“æé†’æ™‚é–“
def schedule_menstrual_reminders():
    """è¨­ç½®æœˆç¶“æé†’çš„å®šæ™‚ä»»å‹™"""
    config = load_config()
    reminder_times = config.get('menstrual', {}).get('reminder_times', ["08:00", "23:50"])
    for reminder_time in reminder_times:
        schedule.every().day.at(reminder_time).do(send_menstrual_reminder)
    menstrual_logger.info(f"æœˆç¶“æé†’å·²è¨­å®šï¼Œå°‡å¾ {reminder_start_date.strftime('%Y-%m-%d')} é–‹å§‹ï¼Œæ¯å¤©ç™¼é€æé†’å…± {reminder_duration} å¤©")
    print(f"æœˆç¶“æé†’å·²è¨­å®šï¼Œå°‡å¾ {reminder_start_date.strftime('%Y-%m-%d')} é–‹å§‹ï¼Œæ¯å¤©ç™¼é€æé†’å…± {reminder_duration} å¤©")  # çµ‚ç«¯æ©Ÿé¡¯ç¤ºè©³ç´°è¨­å®š

# ç™¼é€å•Ÿå‹•è¨Šæ¯ä¸¦è¨˜éŒ„
def send_startup_message():
    """é¸æ“‡å®ŒTOKENå¾Œç™¼é€å•Ÿå‹•è¨Šæ¯åˆ° LINE Notify"""
    startup_message = f"ğŸ“£ Line Notify æ©Ÿå™¨äººå·²å•Ÿå‹•ã€‚"
    send_line_notify(startup_message, weather_logger)

# è¨­å®šæ¯å¤©åŸ·è¡Œä»»å‹™æ™‚é–“
def schedule_weather_notifications():
    try:
        config = load_config()
        notify_times = config.get('weather_times', [])
        for notify_time in notify_times:
            schedule.every().day.at(notify_time).do(job_weather)
            weather_logger.info(f"å·²è¨­å®šå¤©æ°£é å ±æé†’æ™‚é–“: {notify_time}")
    except (FileNotFoundError, ValueError) as e:
        weather_logger.error(f"é…ç½®æ–‡ä»¶éŒ¯èª¤: {e}")
        exit(1)

# åŸ·è¡Œè¨­ç½®
def setup():
    # è¨­å®šå¤©æ°£æé†’
    schedule_weather_notifications()
    
    # è¨­å®šå–æ°´æé†’
    schedule_drink_water_reminder()
    
    # è¨­å®šæœˆç¶“æé†’
    schedule_menstrual_reminders()
    
    # ç™¼é€å•Ÿå‹•è¨Šæ¯
    send_startup_message()

# å‘¼å«è¨­ç½®å‡½æ•¸
setup()

# æŒçºŒé‹è¡Œä»»å‹™
while True:
    schedule.run_pending()
    time.sleep(60)  # ç­‰å¾…60ç§’å†æª¢æŸ¥
